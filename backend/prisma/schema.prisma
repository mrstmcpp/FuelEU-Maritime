// This is your Prisma schema file
// Learn more: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

/////////////////////////////////////////////////////////////
// ROUTE MODEL
// ----------------------------------------------------------
// Basic route information with GHG intensity data.
/////////////////////////////////////////////////////////////

model Route {
  id              Int      @id @default(autoincrement())
  routeId         String   @map("route_id")
  vesselType      String   @map("vessel_type")
  fuelType        String   @map("fuel_type")
  year            Int
  ghgIntensity    Float    @map("ghg_intensity")
  fuelConsumption Float    @map("fuel_consumption")
  distance        Float
  totalEmissions  Float    @map("total_emissions")
  isBaseline      Boolean  @default(false) @map("is_baseline")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  @@map("routes")
  @@index([routeId, year])
}

/////////////////////////////////////////////////////////////
// SHIP MODEL
// ----------------------------------------------------------
// Each ship may have compliance, bank, and pool entries.
/////////////////////////////////////////////////////////////

model Ship {
  id          Int              @id @default(autoincrement())
  shipId      Int              @unique @map("ship_id")
  createdAt   DateTime         @default(now()) @map("created_at")
  updatedAt   DateTime         @updatedAt @map("updated_at")

  compliance  ShipCompliance[]
  bankEntries BankEntry[]
  poolMembers PoolMember[]

  @@map("ships")
}

/////////////////////////////////////////////////////////////
// SHIP COMPLIANCE MODEL
// ----------------------------------------------------------
// Computed carbon balance (CB) records per ship/year.
/////////////////////////////////////////////////////////////

model ShipCompliance {
  id         Int      @id @default(autoincrement())
  shipId     Int      @map("ship_id")
  year       Int
  cbGco2eq   Decimal  @map("cb_gco2eq")
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  ship       Ship     @relation(fields: [shipId], references: [shipId], onDelete: Cascade)

  @@map("ship_compliance")
  @@unique([shipId, year], name: "shipId_year") // ✅ Named composite key
  @@index([shipId, year])
}

/////////////////////////////////////////////////////////////
// BANK ENTRY MODEL
// ----------------------------------------------------------
// Represents carbon banked surplus or deficit for ships.
/////////////////////////////////////////////////////////////

model BankEntry {
  id            Int      @id @default(autoincrement())
  shipId        Int      @map("ship_id")
  year          Int
  amountGco2eq  Decimal  @map("amount_gco2eq")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  ship          Ship     @relation(fields: [shipId], references: [shipId], onDelete: Cascade)

  @@map("bank_entries")
  @@unique([shipId, year], name: "bank_shipId_year") // ✅ Named composite key
  @@index([shipId, year])
}

/////////////////////////////////////////////////////////////
// POOL MODEL
// ----------------------------------------------------------
// Represents pooling registry for ships' compliance data.
/////////////////////////////////////////////////////////////

model Pool {
  id         Int          @id @default(autoincrement())
  year       Int
  createdAt  DateTime     @default(now()) @map("created_at")
  updatedAt  DateTime     @updatedAt @map("updated_at")

  members    PoolMember[]

  @@map("pools")
  @@index([year])
}

/////////////////////////////////////////////////////////////
// POOL MEMBER MODEL
// ----------------------------------------------------------
// Allocations for ships in a pool with CB before/after.
/////////////////////////////////////////////////////////////

model PoolMember {
  poolId     Int      @map("pool_id")
  shipId     Int      @map("ship_id")
  cbBefore   Decimal  @map("cb_before")
  cbAfter    Decimal  @map("cb_after")
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  pool       Pool     @relation(fields: [poolId], references: [id], onDelete: Cascade)
  ship       Ship     @relation(fields: [shipId], references: [shipId], onDelete: Cascade)

  @@id([poolId, shipId], name: "poolId_shipId") // ✅ Named composite primary key
  @@map("pool_members")
  @@index([poolId])
  @@index([shipId])
}
